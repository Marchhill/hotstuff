<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>consensus_impl.ml &mdash; Coverage report</title>
    <meta name="description" content="100.00% coverage in consensus/consensus_impl.ml">
    <link rel="stylesheet" href="../coverage.css"/>
    <script src="../highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div id="header">
      <h1>
        <a href="../index.html">
          <span class="dirname">consensus/</span>consensus_impl.ml
        </a>
      </h1>
      <h2>100.00%</h2>
    </div>
    <div id="navbar">
    </div>
    <div id="report">
      <div id="lines-layer">
        <pre>
<a id="L1"></a><span > </span>
<a id="L2"></a><span > </span>
<a id="L3"></a><span > </span>
<a id="L4"></a><span > </span>
<a id="L5"></a><span > </span>
<a id="L6"></a><span > </span>
<a id="L7"></a><span > </span>
<a id="L8"></a><span > </span>
<a id="L9"></a><span > </span>
<a id="L10"></a><span > </span>
<a id="L11"></a><span > </span>
<a id="L12"></a><span > </span>
<a id="L13"></a><span > </span>
<a id="L14"></a><span class="visited"> </span>
<a id="L15"></a><span > </span>
<a id="L16"></a><span > </span>
<a id="L17"></a><span class="visited"> </span>
<a id="L18"></a><span class="visited"> </span>
<a id="L19"></a><span > </span>
<a id="L20"></a><span > </span>
<a id="L21"></a><span > </span>
<a id="L22"></a><span class="visited"> </span>
<a id="L23"></a><span class="visited"> </span>
<a id="L24"></a><span class="visited"> </span>
<a id="L25"></a><span class="visited"> </span>
<a id="L26"></a><span > </span>
<a id="L27"></a><span > </span>
<a id="L28"></a><span class="visited"> </span>
<a id="L29"></a><span class="visited"> </span>
<a id="L30"></a><span > </span>
<a id="L31"></a><span class="visited"> </span>
<a id="L32"></a><span > </span>
<a id="L33"></a><span > </span>
<a id="L34"></a><span class="visited"> </span>
<a id="L35"></a><span class="visited"> </span>
<a id="L36"></a><span > </span>
<a id="L37"></a><span class="visited"> </span>
<a id="L38"></a><span > </span>
<a id="L39"></a><span > </span>
<a id="L40"></a><span class="visited"> </span>
<a id="L41"></a><span class="visited"> </span>
<a id="L42"></a><span class="visited"> </span>
<a id="L43"></a><span class="visited"> </span>
<a id="L44"></a><span > </span>
<a id="L45"></a><span class="visited"> </span>
<a id="L46"></a><span class="visited"> </span>
<a id="L47"></a><span > </span>
<a id="L48"></a><span > </span>
<a id="L49"></a><span class="visited"> </span>
<a id="L50"></a><span > </span>
<a id="L51"></a><span > </span>
<a id="L52"></a><span class="visited"> </span>
<a id="L53"></a><span class="visited"> </span>
<a id="L54"></a><span class="visited"> </span>
<a id="L55"></a><span class="visited"> </span>
<a id="L56"></a><span class="visited"> </span>
<a id="L57"></a><span class="visited"> </span>
<a id="L58"></a><span > </span>
<a id="L59"></a><span > </span>
<a id="L60"></a><span > </span>
<a id="L61"></a><span > </span>
<a id="L62"></a><span class="visited"> </span>
<a id="L63"></a><span class="visited"> </span>
<a id="L64"></a><span > </span>
<a id="L65"></a><span class="visited"> </span>
<a id="L66"></a><span class="visited"> </span>
<a id="L67"></a><span > </span>
<a id="L68"></a><span class="visited"> </span>
<a id="L69"></a><span > </span>
<a id="L70"></a><span class="visited"> </span>
<a id="L71"></a><span > </span>
<a id="L72"></a><span > </span>
<a id="L73"></a><span > </span>
<a id="L74"></a><span > </span>
<a id="L75"></a><span > </span>
<a id="L76"></a><span > </span>
<a id="L77"></a><span > </span>
<a id="L78"></a><span > </span>
<a id="L79"></a><span > </span>
<a id="L80"></a><span > </span>
<a id="L81"></a><span class="visited"> </span>
<a id="L82"></a><span class="visited"> </span>
<a id="L83"></a><span class="visited"> </span>
<a id="L84"></a><span > </span>
<a id="L85"></a><span > </span>
<a id="L86"></a><span class="visited"> </span>
<a id="L87"></a><span > </span>
<a id="L88"></a><span > </span>
<a id="L89"></a><span > </span>
<a id="L90"></a><span > </span>
<a id="L91"></a><span class="visited"> </span>
<a id="L92"></a><span class="visited"> </span>
<a id="L93"></a><span class="visited"> </span>
<a id="L94"></a><span > </span>
<a id="L95"></a><span class="visited"> </span>
<a id="L96"></a><span > </span>
<a id="L97"></a><span class="visited"> </span>
<a id="L98"></a><span class="visited"> </span>
<a id="L99"></a><span > </span>
<a id="L100"></a><span class="visited"> </span>
<a id="L101"></a><span > </span>
<a id="L102"></a><span > </span>
<a id="L103"></a><span > </span>
<a id="L104"></a><span class="visited"> </span>
<a id="L105"></a><span > </span>
<a id="L106"></a><span class="visited"> </span>
<a id="L107"></a><span class="visited"> </span>
<a id="L108"></a><span > </span>
<a id="L109"></a><span class="visited"> </span>
<a id="L110"></a><span > </span>
<a id="L111"></a><span class="visited"> </span>
<a id="L112"></a><span class="visited"> </span>
<a id="L113"></a><span > </span>
<a id="L114"></a><span class="visited"> </span>
<a id="L115"></a><span > </span>
<a id="L116"></a><span > </span>
<a id="L117"></a><span > </span>
<a id="L118"></a><span class="visited"> </span>
<a id="L119"></a><span > </span>
<a id="L120"></a><span class="visited"> </span>
<a id="L121"></a><span class="visited"> </span>
<a id="L122"></a><span > </span>
<a id="L123"></a><span class="visited"> </span>
<a id="L124"></a><span > </span>
<a id="L125"></a><span class="visited"> </span>
<a id="L126"></a><span class="visited"> </span>
<a id="L127"></a><span > </span>
<a id="L128"></a><span class="visited"> </span>
<a id="L129"></a><span class="visited"> </span>
<a id="L130"></a><span class="visited"> </span>
<a id="L131"></a><span class="visited"> </span>
<a id="L132"></a><span > </span>
<a id="L133"></a><span class="visited"> </span>
<a id="L134"></a><span > </span>
<a id="L135"></a><span > </span>
<a id="L136"></a><span class="visited"> </span>
<a id="L137"></a><span > </span>
<a id="L138"></a><span class="visited"> </span>
<a id="L139"></a><span > </span>
<a id="L140"></a><span class="visited"> </span>
<a id="L141"></a><span > </span>
<a id="L142"></a><span > </span>
<a id="L143"></a><span > </span>
<a id="L144"></a><span class="visited"> </span>
<a id="L145"></a><span class="visited"> </span>
<a id="L146"></a><span > </span>
<a id="L147"></a><span > </span>
<a id="L148"></a><span > </span>
<a id="L149"></a><span > </span>
<a id="L150"></a><span > </span>
<a id="L151"></a><span > </span>
<a id="L152"></a><span > </span>
<a id="L153"></a><span > </span>
<a id="L154"></a><span class="visited"> </span>
<a id="L155"></a><span > </span>
<a id="L156"></a><span > </span>
<a id="L157"></a><span > </span>
<a id="L158"></a><span class="visited"> </span>
<a id="L159"></a><span > </span>
<a id="L160"></a><span class="visited"> </span>
<a id="L161"></a><span class="visited"> </span>
<a id="L162"></a><span > </span>
<a id="L163"></a><span > </span>
<a id="L164"></a><span class="visited"> </span>
<a id="L165"></a><span class="visited"> </span>
<a id="L166"></a><span class="visited"> </span>
<a id="L167"></a><span > </span>
<a id="L168"></a><span > </span>
<a id="L169"></a><span class="visited"> </span>
<a id="L170"></a><span class="visited"> </span>
<a id="L171"></a><span class="visited"> </span>
<a id="L172"></a><span class="visited"> </span>
<a id="L173"></a><span > </span>
<a id="L174"></a><span > </span>
<a id="L175"></a><span class="visited"> </span>
<a id="L176"></a><span > </span>
<a id="L177"></a><span class="visited"> </span>
<a id="L178"></a><span > </span>
<a id="L179"></a><span > </span>
<a id="L180"></a><span > </span>
<a id="L181"></a><span class="visited"> </span>
<a id="L182"></a><span class="visited"> </span>
<a id="L183"></a><span class="visited"> </span>
<a id="L184"></a><span class="visited"> </span>
<a id="L185"></a><span class="visited"> </span>
<a id="L186"></a><span class="visited"> </span>
<a id="L187"></a><span > </span>
<a id="L188"></a><span > </span>
<a id="L189"></a><span > </span>
<a id="L190"></a><span class="visited"> </span>
<a id="L191"></a><span > </span>
<a id="L192"></a><span class="visited"> </span>
<a id="L193"></a><span class="visited"> </span>
<a id="L194"></a><span class="visited"> </span>
<a id="L195"></a><span class="visited"> </span>
<a id="L196"></a><span class="visited"> </span>
<a id="L197"></a><span > </span>
<a id="L198"></a><span > </span>
<a id="L199"></a><span > </span>
<a id="L200"></a><span class="visited"> </span>
<a id="L201"></a><span > </span>
<a id="L202"></a><span class="visited"> </span>
<a id="L203"></a><span class="visited"> </span>
<a id="L204"></a><span class="visited"> </span>
<a id="L205"></a><span class="visited"> </span>
<a id="L206"></a><span > </span>
<a id="L207"></a><span class="visited"> </span>
<a id="L208"></a><span class="visited"> </span>
<a id="L209"></a><span class="visited"> </span>
<a id="L210"></a><span > </span>
<a id="L211"></a><span class="visited"> </span>
<a id="L212"></a><span class="visited"> </span>
<a id="L213"></a><span class="visited"> </span>
<a id="L214"></a><span > </span>
<a id="L215"></a><span class="visited"> </span>
<a id="L216"></a><span > </span>
<a id="L217"></a><span class="visited"> </span>
<a id="L218"></a><span > </span>
<a id="L219"></a><span > </span>
<a id="L220"></a><span > </span>
<a id="L221"></a><span class="visited"> </span>
<a id="L222"></a><span class="visited"> </span>
<a id="L223"></a><span class="visited"> </span>
<a id="L224"></a><span class="visited"> </span>
<a id="L225"></a><span > </span>
<a id="L226"></a><span class="visited"> </span>
<a id="L227"></a><span > </span>
<a id="L228"></a><span > </span>
<a id="L229"></a><span > </span>
<a id="L230"></a><span class="visited"> </span>
<a id="L231"></a><span > </span>
<a id="L232"></a><span class="visited"> </span>
<a id="L233"></a><span > </span>
<a id="L234"></a><span class="visited"> </span>
<a id="L235"></a><span class="visited"> </span>
<a id="L236"></a><span > </span>
<a id="L237"></a><span class="visited"> </span>
<a id="L238"></a><span class="visited"> </span>
<a id="L239"></a><span class="visited"> </span>
<a id="L240"></a><span class="visited"> </span>
<a id="L241"></a><span > </span>
<a id="L242"></a><span class="visited"> </span>
<a id="L243"></a><span > </span>
<a id="L244"></a><span > </span>
<a id="L245"></a><span > </span>
<a id="L246"></a><span class="visited"> </span>
<a id="L247"></a><span class="visited"> </span>
<a id="L248"></a><span class="visited"> </span>
<a id="L249"></a><span class="visited"> </span>
<a id="L250"></a><span > </span>
<a id="L251"></a><span class="visited"> </span>
<a id="L252"></a><span > </span>
<a id="L253"></a><span class="visited"> </span>
</pre>
      </div>
      <div id="text-layer">
        <pre id="line-numbers">
<a href="#L1">  1</a>
<a href="#L2">  2</a>
<a href="#L3">  3</a>
<a href="#L4">  4</a>
<a href="#L5">  5</a>
<a href="#L6">  6</a>
<a href="#L7">  7</a>
<a href="#L8">  8</a>
<a href="#L9">  9</a>
<a href="#L10"> 10</a>
<a href="#L11"> 11</a>
<a href="#L12"> 12</a>
<a href="#L13"> 13</a>
<a href="#L14"> 14</a>
<a href="#L15"> 15</a>
<a href="#L16"> 16</a>
<a href="#L17"> 17</a>
<a href="#L18"> 18</a>
<a href="#L19"> 19</a>
<a href="#L20"> 20</a>
<a href="#L21"> 21</a>
<a href="#L22"> 22</a>
<a href="#L23"> 23</a>
<a href="#L24"> 24</a>
<a href="#L25"> 25</a>
<a href="#L26"> 26</a>
<a href="#L27"> 27</a>
<a href="#L28"> 28</a>
<a href="#L29"> 29</a>
<a href="#L30"> 30</a>
<a href="#L31"> 31</a>
<a href="#L32"> 32</a>
<a href="#L33"> 33</a>
<a href="#L34"> 34</a>
<a href="#L35"> 35</a>
<a href="#L36"> 36</a>
<a href="#L37"> 37</a>
<a href="#L38"> 38</a>
<a href="#L39"> 39</a>
<a href="#L40"> 40</a>
<a href="#L41"> 41</a>
<a href="#L42"> 42</a>
<a href="#L43"> 43</a>
<a href="#L44"> 44</a>
<a href="#L45"> 45</a>
<a href="#L46"> 46</a>
<a href="#L47"> 47</a>
<a href="#L48"> 48</a>
<a href="#L49"> 49</a>
<a href="#L50"> 50</a>
<a href="#L51"> 51</a>
<a href="#L52"> 52</a>
<a href="#L53"> 53</a>
<a href="#L54"> 54</a>
<a href="#L55"> 55</a>
<a href="#L56"> 56</a>
<a href="#L57"> 57</a>
<a href="#L58"> 58</a>
<a href="#L59"> 59</a>
<a href="#L60"> 60</a>
<a href="#L61"> 61</a>
<a href="#L62"> 62</a>
<a href="#L63"> 63</a>
<a href="#L64"> 64</a>
<a href="#L65"> 65</a>
<a href="#L66"> 66</a>
<a href="#L67"> 67</a>
<a href="#L68"> 68</a>
<a href="#L69"> 69</a>
<a href="#L70"> 70</a>
<a href="#L71"> 71</a>
<a href="#L72"> 72</a>
<a href="#L73"> 73</a>
<a href="#L74"> 74</a>
<a href="#L75"> 75</a>
<a href="#L76"> 76</a>
<a href="#L77"> 77</a>
<a href="#L78"> 78</a>
<a href="#L79"> 79</a>
<a href="#L80"> 80</a>
<a href="#L81"> 81</a>
<a href="#L82"> 82</a>
<a href="#L83"> 83</a>
<a href="#L84"> 84</a>
<a href="#L85"> 85</a>
<a href="#L86"> 86</a>
<a href="#L87"> 87</a>
<a href="#L88"> 88</a>
<a href="#L89"> 89</a>
<a href="#L90"> 90</a>
<a href="#L91"> 91</a>
<a href="#L92"> 92</a>
<a href="#L93"> 93</a>
<a href="#L94"> 94</a>
<a href="#L95"> 95</a>
<a href="#L96"> 96</a>
<a href="#L97"> 97</a>
<a href="#L98"> 98</a>
<a href="#L99"> 99</a>
<a href="#L100">100</a>
<a href="#L101">101</a>
<a href="#L102">102</a>
<a href="#L103">103</a>
<a href="#L104">104</a>
<a href="#L105">105</a>
<a href="#L106">106</a>
<a href="#L107">107</a>
<a href="#L108">108</a>
<a href="#L109">109</a>
<a href="#L110">110</a>
<a href="#L111">111</a>
<a href="#L112">112</a>
<a href="#L113">113</a>
<a href="#L114">114</a>
<a href="#L115">115</a>
<a href="#L116">116</a>
<a href="#L117">117</a>
<a href="#L118">118</a>
<a href="#L119">119</a>
<a href="#L120">120</a>
<a href="#L121">121</a>
<a href="#L122">122</a>
<a href="#L123">123</a>
<a href="#L124">124</a>
<a href="#L125">125</a>
<a href="#L126">126</a>
<a href="#L127">127</a>
<a href="#L128">128</a>
<a href="#L129">129</a>
<a href="#L130">130</a>
<a href="#L131">131</a>
<a href="#L132">132</a>
<a href="#L133">133</a>
<a href="#L134">134</a>
<a href="#L135">135</a>
<a href="#L136">136</a>
<a href="#L137">137</a>
<a href="#L138">138</a>
<a href="#L139">139</a>
<a href="#L140">140</a>
<a href="#L141">141</a>
<a href="#L142">142</a>
<a href="#L143">143</a>
<a href="#L144">144</a>
<a href="#L145">145</a>
<a href="#L146">146</a>
<a href="#L147">147</a>
<a href="#L148">148</a>
<a href="#L149">149</a>
<a href="#L150">150</a>
<a href="#L151">151</a>
<a href="#L152">152</a>
<a href="#L153">153</a>
<a href="#L154">154</a>
<a href="#L155">155</a>
<a href="#L156">156</a>
<a href="#L157">157</a>
<a href="#L158">158</a>
<a href="#L159">159</a>
<a href="#L160">160</a>
<a href="#L161">161</a>
<a href="#L162">162</a>
<a href="#L163">163</a>
<a href="#L164">164</a>
<a href="#L165">165</a>
<a href="#L166">166</a>
<a href="#L167">167</a>
<a href="#L168">168</a>
<a href="#L169">169</a>
<a href="#L170">170</a>
<a href="#L171">171</a>
<a href="#L172">172</a>
<a href="#L173">173</a>
<a href="#L174">174</a>
<a href="#L175">175</a>
<a href="#L176">176</a>
<a href="#L177">177</a>
<a href="#L178">178</a>
<a href="#L179">179</a>
<a href="#L180">180</a>
<a href="#L181">181</a>
<a href="#L182">182</a>
<a href="#L183">183</a>
<a href="#L184">184</a>
<a href="#L185">185</a>
<a href="#L186">186</a>
<a href="#L187">187</a>
<a href="#L188">188</a>
<a href="#L189">189</a>
<a href="#L190">190</a>
<a href="#L191">191</a>
<a href="#L192">192</a>
<a href="#L193">193</a>
<a href="#L194">194</a>
<a href="#L195">195</a>
<a href="#L196">196</a>
<a href="#L197">197</a>
<a href="#L198">198</a>
<a href="#L199">199</a>
<a href="#L200">200</a>
<a href="#L201">201</a>
<a href="#L202">202</a>
<a href="#L203">203</a>
<a href="#L204">204</a>
<a href="#L205">205</a>
<a href="#L206">206</a>
<a href="#L207">207</a>
<a href="#L208">208</a>
<a href="#L209">209</a>
<a href="#L210">210</a>
<a href="#L211">211</a>
<a href="#L212">212</a>
<a href="#L213">213</a>
<a href="#L214">214</a>
<a href="#L215">215</a>
<a href="#L216">216</a>
<a href="#L217">217</a>
<a href="#L218">218</a>
<a href="#L219">219</a>
<a href="#L220">220</a>
<a href="#L221">221</a>
<a href="#L222">222</a>
<a href="#L223">223</a>
<a href="#L224">224</a>
<a href="#L225">225</a>
<a href="#L226">226</a>
<a href="#L227">227</a>
<a href="#L228">228</a>
<a href="#L229">229</a>
<a href="#L230">230</a>
<a href="#L231">231</a>
<a href="#L232">232</a>
<a href="#L233">233</a>
<a href="#L234">234</a>
<a href="#L235">235</a>
<a href="#L236">236</a>
<a href="#L237">237</a>
<a href="#L238">238</a>
<a href="#L239">239</a>
<a href="#L240">240</a>
<a href="#L241">241</a>
<a href="#L242">242</a>
<a href="#L243">243</a>
<a href="#L244">244</a>
<a href="#L245">245</a>
<a href="#L246">246</a>
<a href="#L247">247</a>
<a href="#L248">248</a>
<a href="#L249">249</a>
<a href="#L250">250</a>
<a href="#L251">251</a>
<a href="#L252">252</a>
<a href="#L253">253</a>
</pre>
<pre><code class="ocaml">open Types
open Util
open Crypto

(* phase only used for debugging purposes *)
type phase = Prepare | PreCommit | Commit | Decide

(* Leader contains own local variables *)
type role = Leader of {m: event list; vpc: event list; vc: event list; vd: event list; has_proposed: bool} | Replica

type state = {phase: phase; role: role; locked_qc: qc option; prepare_qc: qc option; nv: event list}
type t = {view: int; id: int; node_count: int; batch_size: int; cmds: Cmd_set.t;  seen: Cmd_set.t; crypto: crypto option; complain: (int, event list) Hashtbl.t; s: state}

let b_0 = make_nod<span data-count="1">e</span> Cmd_set.empty None None
let qc_0 = {node = Some b_0; view = 0; signature = None; msg_type = PrepareAck; ids = []}

let get_qc_0 () = (<span data-count="1">N</span>one : qc option)
let get_b_0 () = (<span data-count="1">N</span>one : node option)

(* utils *)
let phase_to_string : (phase -&gt; string)= function
  | <span data-count="170">P</span>repare -&gt; "prepare"
  | <span data-count="44">P</span>reCommit -&gt; "pre_commit"
  | <span data-count="44">C</span>ommit -&gt; "commit"
  | <span data-count="64">D</span>ecide -&gt; "decide"

let role_to_string = function
  | <span data-count="82">L</span>eader _ -&gt; "leader"
  | <span data-count="240">R</span>eplica -&gt; "replica"

let print_state state = <span data-count="322">F</span>mt.pr "state id=%d phase=%s role=%s view=%d@." state.id (phase_to_strin<span data-count="322">g</span> state.s.phase) (role_to_strin<span data-count="322">g</span> state.s.role) state.view

let get_role view id node_count nv =
  <span data-count="225">i</span>f is_leader view id node_count then
    <span data-count="60">L</span>eader {m = nv; vpc = []; vc = []; vd = []; has_proposed = false}
  else
    <span data-count="165">R</span>eplica

let max_qc (qc1 : qc option) (qc2 : qc option) =
  <span data-count="131">m</span>atch qc1, qc2 with
    | <span data-count="83">S</span>ome qc1, Some qc2 -&gt; if qc1.view &gt; qc2.view then <span data-count="1">S</span>ome qc1 else <span data-count="82">S</span>ome qc2
    | <span data-count="1">S</span>ome qc, None | <span data-count="41">N</span>one, Some qc -&gt; Some qc
    | <span data-count="6">N</span>one, None -&gt; None

let get_high_qc = List.fold_lef<span data-count="1">t</span> (fun acc e2 -&gt;
  <span data-count="130">l</span>et msg = (match get_msg_from_event e2 with <span data-count="129">S</span>ome msg -&gt; msg | <span data-count="1">N</span>one -&gt; raise EventTypeNotFoundException) in
  max_qc acc msg.justify) None

let create_leaf (n : node option) (c : Cmd_set.t) = <span data-count="45">S</span>ome (make_nod<span data-count="45">e</span> c n None)

let safe_node (n : node option) (qc : qc option) (lockedQC : qc option) =
  <span data-count="163">m</span>atch qc, lockedQC with
    | <span data-count="161">S</span>ome qc, Some lockedQC -&gt; 
      extend<span data-count="161">s</span> n lockedQC.nod<span data-count="160">e</span> || (* safety rule *)
      qc.view &gt; lockedQC.vie<span data-count="1">w</span> (* liveness rule *)
    | <span data-count="1">_</span>, None -&gt; true
    | <span data-count="1">N</span>one, Some _ -&gt; false

(* --- *)

let as_leader state event =
  <span data-count="1409">m</span>atch state.s.role with
    | <span data-count="865">L</span>eader l -&gt;
      (match event with
        | <span data-count="173">N</span>ewView msg when msg.view = state.view - 1 &amp;&amp; <span data-count="172">n</span>ot(l.has_proposed) -&gt;
          <span data-count="129">l</span>et m' = event::(l.m) in
          let q = is_quorum m' state.node_count in
          <span data-count="129">l</span>et state = {state with s = {state.s with role = Leader {l with m = m'}}} in
          if q then
            <span data-count="43">l</span>et highQC = get_high_qc m' in
            (*
            let exec = Queue.take_opt state.cmds in
            let cmd = (match exec with
              | Some cmd -&gt;
                Queue.add cmd state.exec;
                cmd
              | None -&gt; {data = "#"; callback_id = ""}(* noop *)
            )
            in
            *)
            <span data-count="43">l</span>et curProposal = match highQC with
              | <span data-count="41">S</span>ome qc -&gt; create_lea<span data-count="41">f</span> qc.node state.cmds (* extend log *)
              | <span data-count="2">N</span>one -&gt; create_lea<span data-count="2">f</span> None state.cmds (* should only happen in view 1 *)
            in
            let broadcast_msg = sign state.crypto ({id = state.id; view = state.view; tcp_lens = []; msg_type = Prepare; node = curProposal; justify = highQC; partial_signature = None}) in
            <span data-count="43">(</span>
              {state with s = {state.s with role = Leader {l with has_proposed = true}}; cmds = Cmd_set.empty},
              [Broadcast broadcast_msg]
            )
          else
            <span data-count="86">(</span>state, [])
        | <span data-count="172">P</span>repareAck msg when msg.view = state.view &amp;&amp; <span data-count="172">n</span>ot(is_quoru<span data-count="172">m</span> l.vpc state.node_count) -&gt;
          <span data-count="129">l</span>et vpc' = event::(l.vpc) in
          let q = get_quorum vpc' state.node_count in
          <span data-count="129">l</span>et state = {state with s = {state.s with role = Leader {l with vpc = vpc'}}}in
          (match q with
            | <span data-count="43">S</span>ome q -&gt;
              let prepareQC = Some (threshold_q<span data-count="43">c</span> state.crypto q) in
              let broadcast_msg = sign state.crypto ({id = state.id; view = state.view; tcp_lens = []; msg_type = PreCommit; node = None; justify = prepareQC; partial_signature = None}) in
              <span data-count="43">(</span>
                state,
                [Broadcast broadcast_msg]
              )
            | <span data-count="86">N</span>one -&gt; (state, [])
          )
        | <span data-count="172">P</span>reCommitAck msg when msg.view = state.view &amp;&amp; <span data-count="172">n</span>ot(is_quoru<span data-count="172">m</span> l.vc state.node_count) -&gt;
          <span data-count="129">l</span>et vc' = event::(l.vc) in
          let q = get_quorum vc' state.node_count in
          <span data-count="129">l</span>et state = {state with s = {state.s with role = Leader {l with vc = vc'}}} in
          (match q with
            | <span data-count="43">S</span>ome q -&gt;
              let precommitQC = Some (threshold_q<span data-count="43">c</span> state.crypto q) in
              let broadcast_msg = sign state.crypto ({id = state.id; view = state.view; tcp_lens = []; msg_type = Commit; node = None; justify = precommitQC; partial_signature = None}) in
              <span data-count="43">(</span>
                state,
                [Broadcast broadcast_msg]
              )
            | <span data-count="86">N</span>one -&gt; (state, [])
          )
        | <span data-count="172">C</span>ommitAck msg when msg.view = state.view &amp;&amp; <span data-count="172">n</span>ot(is_quoru<span data-count="172">m</span> l.vd state.node_count) -&gt;
          <span data-count="129">l</span>et vd' = event::(l.vd) in
          let q = get_quorum vd' state.node_count in
          <span data-count="129">l</span>et state = {state with s = {state.s with role = Leader {l with vd = vd'}}} in
          (match q with
            | <span data-count="43">S</span>ome q -&gt;
              let commitQC = Some (threshold_q<span data-count="43">c</span> state.crypto q) in
              let broadcast_msg = sign state.crypto ({id = state.id; view = state.view; tcp_lens = []; msg_type = Decide; node = None; justify = commitQC; partial_signature = None}) in
              <span data-count="43">l</span>et cmds = match msg.node with <span data-count="42">S</span>ome n -&gt; n.cmds | <span data-count="1">N</span>one -&gt; Cmd_set.empty in
              let actions = (Broadcast broadcast_msg) :: (Cmd_set.fol<span data-count="43">d</span> (fun cmd acc -&gt;
                <span data-count="5">i</span>f cmd.callback_id = Int64.zero then
                  <span data-count="1">a</span>cc
                else
                  <span data-count="4">(</span>SendClient {id = state.id; callback_id = cmd.callback_id; success = true})::acc
              ) cmds []) in
              (state, actions)
            | <span data-count="86">N</span>one -&gt; (state, [])
          )
        | <span data-count="349">_</span> -&gt; (state, [])
      )
    | <span data-count="544">R</span>eplica -&gt; (state, [])

(* reset state and assume phase is over, go to view 'view' *)
let finally state view =
  <span data-count="172">l</span>et role = get_role view state.id state.node_count state.s.nv in
  <span data-count="172">l</span>et state' = {state with
    view = view;
    s = {state.s with
      role = role;
      phase = Prepare;
      nv = []
    }
  } in
  let msg = sign state.crypto ({id = state.id; view = (view - 1); tcp_lens = []; msg_type = NewView; node = None; justify = state.s.prepare_qc; partial_signature = None}) in
  <span data-count="172">l</span>et actions = [SendNextLeader msg; ResetTimer {id = state.id; view = view}] in
  (state', actions)

let execute state = function
  | <span data-count="160">S</span>ome n -&gt;
    let state, actions = finally state (state.view + 1) in
    <span data-count="160">(</span>state, (Execute {id = state.id; node = n}) :: actions)
  | <span data-count="1">N</span>one -&gt; (state, [])

let as_replica state (event : event) =
  <span data-count="1409">l</span>et qc = (match get_msg_from_event event with
      | <span data-count="1380">S</span>ome msg -&gt; if (verify_threshold_qc state.crypto state.node_count (Some qc_0) msg.justify) then <span data-count="936">m</span>sg.justify else <span data-count="444">N</span>one
    | <span data-count="29">N</span>one -&gt; None
  ) in
  match event with
    | <span data-count="164">P</span>repare msg when state.view = msg.view -&gt;
      <span data-count="164">l</span>et is_safe = (match qc with
        | <span data-count="160">S</span>ome qc -&gt; (extend<span data-count="160">s</span> msg.node qc.node) &amp;&amp; (<span data-count="160">s</span>afe_nod<span data-count="160">e</span> msg.node msg.justify state.s.locked_qc)
        | <span data-count="4">N</span>one -&gt; false
      ) in
      if is_safe then
        <span data-count="160">(</span>
          let vote_msg = sign state.crypto ({id = state.id; view = state.view; tcp_lens = []; msg_type = PrepareAck; node = msg.node; justify = None; partial_signature = None}) in
          <span data-count="160">{</span>state with s = {state.s with phase = PreCommit}},
          [SendLeader vote_msg]
        )
      else
        <span data-count="4">(</span>state, [])
    | <span data-count="164">P</span>reCommit msg when state.view = msg.view -&gt;
      <span data-count="164">(</span>match qc with
        | <span data-count="160">S</span>ome qc when (matching_q<span data-count="160">c</span> qc PrepareAck state.view) -&gt;
          <span data-count="160">l</span>et vote_msg = sign state.crypto ({id = state.id; view = state.view; tcp_lens = []; msg_type = PreCommitAck; node = qc.node; justify = None; partial_signature = None}) in
          <span data-count="160">(</span>
            {state with s = {state.s with prepare_qc = msg.justify; phase = Commit}},
            [SendLeader vote_msg]
          )
        | <span data-count="4">_</span> -&gt; (state, [])
      )
    | <span data-count="164">C</span>ommit msg when state.view = msg.view -&gt;
      <span data-count="164">(</span>match qc with
        | <span data-count="160">S</span>ome qc when (matching_q<span data-count="160">c</span> qc PreCommitAck state.view) -&gt;
          <span data-count="160">l</span>et vote_msg = sign state.crypto ({id = state.id; view = state.view; tcp_lens = []; msg_type = CommitAck; node = qc.node; justify = None; partial_signature = None}) in
          <span data-count="160">(</span>
            {state with s = {state.s with locked_qc = msg.justify; phase = Decide}},
            [SendLeader vote_msg]
          )
        | <span data-count="4">_</span> -&gt; (state, [])
      )
    | <span data-count="164">D</span>ecide msg when state.view = msg.view -&gt;
      <span data-count="164">(</span>match qc with
        | <span data-count="160">S</span>ome qc when (matching_q<span data-count="160">c</span> qc CommitAck state.view) -&gt; <span data-count="160">e</span>xecute state qc.node
        | <span data-count="4">_</span> -&gt; (state, [])
      )
    | <span data-count="5">C</span>lientCmd cmd -&gt;
      ({state with cmds = Cmd_set.ad<span data-count="5">d</span> cmd state.cmds}, [])
    | <span data-count="16">N</span>extView msg -&gt;
      (match qc with
        | <span data-count="12">S</span>ome qc when qc.msg_type = Complain &amp;&amp; <span data-count="12">m</span>sg.view &gt;= state.view &amp;&amp; <span data-count="12">m</span>sg.view = qc.view -&gt;
          <span data-count="12">f</span>inally state (msg.view + 1)
        | <span data-count="4">_</span> -&gt; (state, [])
      )
    | <span data-count="24">T</span>imeout x -&gt;
      let complain_msg = sign state.crypto ({id = state.id; view = x.view; tcp_lens = []; msg_type = Complain; node = None; justify = None; partial_signature = None}) in
      <span data-count="24">(</span>state, [
        ResetTimer {id = state.id; view = (x.view + 1)}; (* start timeout fot next view *)
        SendNextLeader complain_msg (* complain to next leader *)
        ])
    | <span data-count="16">C</span>omplain msg when (is_leade<span data-count="16">r</span> (msg.view + 1) state.id state.node_count) -&gt;
        <span data-count="16">(</span>match (add_event state.complain event msg.view state.node_count) with
          | <span data-count="4">S</span>ome q -&gt;
            let complainQC = Some (threshold_q<span data-count="4">c</span> state.crypto q) in
            let broadcast_msg = sign state.crypto ({id = state.id; view = msg.view; tcp_lens = []; msg_type = NextView; node = None; justify = complainQC; partial_signature = None}) in
            <span data-count="4">(</span>
              state,
              [Broadcast broadcast_msg]
            )
          | <span data-count="12">N</span>one -&gt; (state, [])
        )
    | <span data-count="176">N</span>ewView msg when msg.view = state.view &amp;&amp; (<span data-count="4">i</span>s_leade<span data-count="4">r</span> (state.view + 1) state.id state.node_count) -&gt;
      (* store new view messages if we are leader for next round and have not yet transitioned (prevents deadlock ??? race condition accessing nv??? ) *)
      <span data-count="1">(</span>{state with s = {state.s with nv = event::state.s.nv}}, [])
    | <span data-count="691">_</span> -&gt; (state, [])

let create_state_machine ?(crypto = <span data-count="16">N</span>one) id node_count _ =
  <span data-count="53">l</span>et r = get_role 1 id node_count [] in
  <span data-count="53">l</span>et s = {phase = Prepare; role = r; locked_qc = Some qc_0; prepare_qc = Some qc_0; nv = []} in
  let state = {view = 1; id = id; node_count = node_count; batch_size = 0; crypto = crypto; cmds = Cmd_set.empty; seen = Cmd_set.empty; complain = (Hashtbl.creat<span data-count="53">e</span> 1000); s = s} in
  let new_view_msg = sign state.crypto ({id = state.id; view = 0; tcp_lens = []; msg_type = NewView; node = None; justify = Some qc_0; partial_signature = None}) in
  <span data-count="53">l</span>et new_view_action = SendNextLeader new_view_msg in
  (state, [new_view_action])

let advance (state : t) (event : event) =
  <span data-count="1410">i</span>f verify_partial_signature state.crypto event then
    <span data-count="1409">l</span>et (state, asLeaderActions) = as_leader state event in
    <span data-count="1409">l</span>et (state, asReplicaActions) =  as_replica state event in
    <span data-count="1409">(</span>state, asLeaderActions @ asReplicaActions)
  else
    <span data-count="1">(</span>state, [])

let create_node_internal (_ : int option) (_ : node_justify option) = (<span data-count="1">N</span>one : node_internal option)
</code></pre>
      </div>
    </div>
    <script src="../coverage.js"></script>
  </body>
</html>
